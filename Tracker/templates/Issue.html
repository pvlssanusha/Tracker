{% extends "base.html" %}
{% load static %}

{% block title %}Add Issue{% endblock %}

{% block content %}
<div id="terms">
    <h2>Terms and Conditions</h2>
    <p>
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed et lectus
        neque. Proin nec commodo arcu. Nullam fringilla lacinia diam, vel
        ultrices mauris consectetur at. Quisque sit amet ligula eget felis
        vestibulum pharetra. Donec vel fringilla ligula. Sed ut placerat sapien.
        Nam volutpat lacus eu velit dignissim, ut consectetur leo efficitur. Sed
        eu dapibus lorem. Phasellus sit amet elit sed magna dictum volutpat.
    </p>
    <button id="acceptTerms">Accept Terms</button>
</div>

<!-- Issue Form (Initially Hidden) -->
<div id="issueForm" style="display: none">
    <div class="issue-form-container">
        <form id="addIssueForm" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit">Submit</button>
        </form>
        <!-- Display form errors -->
        {% if form.errors %}
            <div class="form-errors">
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function () {
        $("#id_company").change(function () {
            var url = "{% url 'load_products' %}";
            var companyId = $(this).val();

            $.ajax({
                url: url,
                data: {
                    company_id: companyId,
                },
                success: function (data) {
                    $("#id_product").html("");
                    // Add an empty option first
                    $("#id_product").append('<option value="">---------</option>');
                    if (data.length > 0) {
                        $.each(data, function (key, value) {
                            $("#id_product").append(
                                '<option value="' +
                                value.id +
                                '">' +
                                value.name +
                                "</option>"
                            );
                        });
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.log('Error loading products:', textStatus, errorThrown);
                }
            });
        });

        // Function to toggle visibility of issue form
        function toggleIssueForm(visible) {
            if (visible) {
                $("#issueForm").show();
            } else {
                $("#issueForm").hide();
            }
        }

        // Initially hide issue form
        toggleIssueForm(false);

        // Handle click event on "Accept Terms" button
        $("#acceptTerms").click(function () {
            // Show issue form when terms are accepted
            toggleIssueForm(true);
            // Hide terms and conditions
            $("#terms").hide();
        });

        // Handle form submission
        $("#addIssueForm").submit(function (event) {
            event.preventDefault();  // Prevent default form submission

            var form = $(this)[0];  // Get the actual HTML form element
            var formData = new FormData(form);

            // AJAX submit the form
            $.ajax({
                url: $(this).attr("action"),
                type: $(this).attr("method"),
                data: formData,
                processData: false,
                contentType: false,
                success: function (data) {
                    // Handle success response
                    console.log("Form submitted successfully");
                    // Optionally, redirect to a success page or update UI
                    window.location.href = "{% url 'issues' %}";  // Redirect to issues list
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    console.error("Form submission error:", errorThrown);
                    // Display error message or handle error scenario
                    alert("Error submitting form. Please try again.");
                }
            });
        });
    });
</script>
{% endblock %}
Z