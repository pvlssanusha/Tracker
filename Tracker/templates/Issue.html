{% extends "base.html" %}
{% load static %}
{% block title %}Add Product{% endblock %}
{% block content %}
    <div id="terms">
        <h2>Terms and Conditions</h2>
        <p>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit. Sed et lectus
            neque. Proin nec commodo arcu. Nullam fringilla lacinia diam, vel
            ultrices mauris consectetur at. Quisque sit amet ligula eget felis
            vestibulum pharetra. Donec vel fringilla ligula. Sed ut placerat sapien.
            Nam volutpat lacus eu velit dignissim, ut consectetur leo efficitur. Sed
            eu dapibus lorem. Phasellus sit amet elit sed magna dictum volutpat.
        </p>
        <button id="acceptTerms">Accept Terms</button>
    </div>

    <!-- Issue Form (Initially Hidden) -->
    <div id="issueForm" style="display: none">
        <div class="issue-form-container">
            <form method="post" class="form" enctype="multipart/form-data">
                {% csrf_token %}
                {{ form.as_p }}
                <button type="submit">Submit</button>
            </form>
            <!-- Display form errors -->
            {% if form.errors %}
                <div class="form-errors">
                    <ul>
                        {% for field in form %}
                            {% for error in field.errors %}
                                <li>{{ error }}</li>
                            {% endfor %}
                        {% endfor %}
                        {% for error in form.non_field_errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        </div>
    </div>

    <script type="text/javascript">
        $(document).ready(function () {
            function toggleFieldVisibility() {
                var companySelected = $("#id_company").val() !== "";
                var productSelected = $("#id_product").val() !== "";

                if (!companySelected) {
                    $("#id_company_name").closest('.form-group').show();
                    $("#id_company_url").closest('.form-group').show();
                    $("#id_company_email").closest('.form-group').show();
                    $("#id_company_bio").closest('.form-group').show();
                    $("#id_company_pic").closest('.form-group').show();
                } else {
                    $("#id_company_name").closest('.form-group').hide();
                    $("#id_company_url").closest('.form-group').hide();
                    $("#id_company_email").closest('.form-group').hide();
                    $("#id_company_bio").closest('.form-group').hide();
                    $("#id_company_pic").closest('.form-group').hide();
                }

                if (companySelected && !productSelected) {
                    $("#id_product_name").closest('.form-group').show();
                    $("#id_product_url").closest('.form-group').show();
                } else {
                    $("#id_product_name").closest('.form-group').hide();
                    $("#id_product_url").closest('.form-group').hide();
                }
            }

            $("#id_company").change(function () {
                var url = "{% url 'load_products' %}";
                var companyId = $(this).val();

                $.ajax({
                    url: url,
                    data: {
                        company_id: companyId,
                    },
                    success: function (data) {
                        $("#id_product").html("");
                        // Add an empty option first
                        $("#id_product").append('<option value="">---------</option>');
                        if (data.length > 0) {
                            $.each(data, function (key, value) {
                                $("#id_product").append(
                                    '<option value="' +
                                    value.id +
                                    '">' +
                                    value.name +
                                    "</option>"
                                );
                            });
                        }
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        console.log('Error loading products:', textStatus, errorThrown);
                    }
                });
                toggleFieldVisibility();
            });

            $("#id_product").change(function () {
                toggleFieldVisibility();
            });

            // Function to toggle visibility of issue form
            function toggleIssueForm(visible) {
                if (visible) {
                    $("#issueForm").show();
                } else {
                    $("#issueForm").hide();
                }
            }

            // Initially hide issue form
            toggleIssueForm(false);

            // Handle click event on "Accept Terms" button
            $("#acceptTerms").click(function () {
                // Show issue form when terms are accepted
                toggleIssueForm(true);
                // Hide terms and conditions
                $("#terms").hide();
            });

            // Initial visibility based on default form values
            toggleFieldVisibility();
        });
    </script>
{% endblock %}
